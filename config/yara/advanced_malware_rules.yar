/*
   Règles YARA avancées pour la détection de malware
   Auteur: IRIS Security Team
   Version: 2.0
   Date: 2024
*/

// Règles pour les ransomwares
rule Ransomware_Behavior {
    meta:
        description = "Détection de comportements de ransomware"
        severity = "critical"
        category = "ransomware"
        author = "IRIS Security Team"
    strings:
        // Extensions de fichiers chiffrés
        $a1 = ".encrypted" nocase
        $a2 = ".locked" nocase
        $a3 = ".crypted" nocase
        $a4 = ".crypto" nocase
        $a5 = ".cryptolocker" nocase
        // Messages de ransomware
        $b1 = "your files have been encrypted" nocase
        $b2 = "pay the ransom" nocase
        $b3 = "decrypt your files" nocase
        $b4 = "bitcoin payment" nocase
        $b5 = "decryption key" nocase
        // Comportements de chiffrement
        $c1 = "CryptoAPI" nocase
        $c2 = "CryptAcquireContext" nocase
        $c3 = "CryptGenKey" nocase
        $c4 = "CryptEncrypt" nocase
        $c5 = "CryptDecrypt" nocase
    condition:
        (2 of ($a*)) or (2 of ($b*)) or (2 of ($c*))
}

// Règles pour les backdoors
rule Backdoor_Behavior {
    meta:
        description = "Détection de comportements de backdoor"
        severity = "critical"
        category = "backdoor"
    strings:
        // Commandes shell
        $a1 = "cmd.exe /c" nocase
        $a2 = "powershell.exe -enc" nocase
        $a3 = "bash -c" nocase
        $a4 = "netcat" nocase
        $a5 = "nc -l" nocase
        // Connexions réseau suspectes
        $b1 = "socket" nocase
        $b2 = "bind" nocase
        $b3 = "listen" nocase
        $b4 = "accept" nocase
        $b5 = "connect" nocase
        // Manipulation de processus
        $c1 = "CreateProcess" nocase
        $c2 = "ShellExecute" nocase
        $c3 = "WinExec" nocase
        $c4 = "system" nocase
        $c5 = "popen" nocase
    condition:
        (2 of ($a*)) or (2 of ($b*)) or (2 of ($c*))
}

// Règles pour les rootkits
rule Rootkit_Behavior {
    meta:
        description = "Détection de comportements de rootkit"
        severity = "critical"
        category = "rootkit"
    strings:
        // Manipulation du noyau
        $a1 = "NtCreateFile" nocase
        $a2 = "NtOpenFile" nocase
        $a3 = "NtQuerySystemInformation" nocase
        $a4 = "NtQueryInformationProcess" nocase
        $a5 = "NtQueryInformationThread" nocase
        // Hooking
        $b1 = "SetWindowsHookEx" nocase
        $b2 = "GetProcAddress" nocase
        $b3 = "LoadLibrary" nocase
        $b4 = "VirtualAlloc" nocase
        $b5 = "WriteProcessMemory" nocase
        // Masquage
        $c1 = "HideProcess" nocase
        $c2 = "HideFile" nocase
        $c3 = "HideRegistry" nocase
        $c4 = "HideDriver" nocase
        $c5 = "HidePort" nocase
    condition:
        (2 of ($a*)) or (2 of ($b*)) or (2 of ($c*))
}

// Règles pour les keyloggers
rule Keylogger_Behavior {
    meta:
        description = "Détection de comportements de keylogger"
        severity = "high"
        category = "keylogger"
    strings:
        // Capture de frappe
        $a1 = "GetAsyncKeyState" nocase
        $a2 = "GetKeyboardState" nocase
        $a3 = "SetWindowsHookEx" nocase
        $a4 = "WH_KEYBOARD" nocase
        $a5 = "WH_KEYBOARD_LL" nocase
        // Fichiers de log
        $b1 = "keylog" nocase
        $b2 = "keystroke" nocase
        $b3 = "keyboard" nocase
        $b4 = "log.txt" nocase
        $b5 = "capture" nocase
    condition:
        (2 of ($a*)) or (2 of ($b*))
}

// Règles pour les botnets
rule Botnet_Behavior {
    meta:
        description = "Détection de comportements de botnet"
        severity = "critical"
        category = "botnet"
    strings:
        // Communication C&C
        $a1 = "irc" nocase
        $a2 = "botnet" nocase
        $a3 = "command and control" nocase
        $a4 = "c&c" nocase
        $a5 = "master" nocase
        // Commandes botnet
        $b1 = "ddos" nocase
        $b2 = "spam" nocase
        $b3 = "scan" nocase
        $b4 = "download" nocase
        $b5 = "update" nocase
        // Protocoles
        $c1 = "http://" nocase
        $c2 = "https://" nocase
        $c3 = "ftp://" nocase
        $c4 = "tcp://" nocase
        $c5 = "udp://" nocase
    condition:
        (2 of ($a*)) or (2 of ($b*)) or (2 of ($c*))
}

// Règles pour les exploits
rule Exploit_Behavior {
    meta:
        description = "Détection de comportements d'exploit"
        severity = "high"
        category = "exploit"
    strings:
        // Techniques d'exploitation
        $a1 = "buffer overflow" nocase
        $a2 = "heap spray" nocase
        $a3 = "rop chain" nocase
        $a4 = "shellcode" nocase
        $a5 = "exploit" nocase
        // Vulnérabilités courantes
        $b1 = "cve-" nocase
        $b2 = "ms17-010" nocase
        $b3 = "eternalblue" nocase
        $b4 = "wannacry" nocase
        $b5 = "notpetya" nocase
    condition:
        (2 of ($a*)) or (2 of ($b*))
}

// Règles pour les droppers
rule Dropper_Behavior {
    meta:
        description = "Détection de comportements de dropper"
        severity = "high"
        category = "dropper"
    strings:
        // Téléchargement
        $a1 = "URLDownloadToFile" nocase
        $a2 = "InternetOpen" nocase
        $a3 = "InternetConnect" nocase
        $a4 = "HttpOpenRequest" nocase
        $a5 = "HttpSendRequest" nocase
        // Exécution
        $b1 = "CreateProcess" nocase
        $b2 = "ShellExecute" nocase
        $b3 = "WinExec" nocase
        $b4 = "system" nocase
        $b5 = "popen" nocase
        // Masquage
        $c1 = "SetFileAttributes" nocase
        $c2 = "MoveFile" nocase
        $c3 = "CopyFile" nocase
        $c4 = "DeleteFile" nocase
        $c5 = "CreateDirectory" nocase
    condition:
        (2 of ($a*)) or (2 of ($b*)) or (2 of ($c*))
}

// Règles pour les stealers
rule Stealer_Behavior {
    meta:
        description = "Détection de comportements de stealer"
        severity = "high"
        category = "stealer"
    strings:
        // Navigateurs
        $a1 = "chrome" nocase
        $a2 = "firefox" nocase
        $a3 = "edge" nocase
        $a4 = "opera" nocase
        $a5 = "brave" nocase
        // Données sensibles
        $b1 = "password" nocase
        $b2 = "credit card" nocase
        $b3 = "crypto" nocase
        $b4 = "wallet" nocase
        $b5 = "private key" nocase
        // Fichiers de configuration
        $c1 = "cookies" nocase
        $c2 = "history" nocase
        $c3 = "bookmarks" nocase
        $c4 = "autofill" nocase
        $c5 = "login data" nocase
    condition:
        (2 of ($a*)) or (2 of ($b*)) or (2 of ($c*))
}

// Règles pour les cryptominers
rule Cryptominer_Behavior {
    meta:
        description = "Détection de comportements de cryptominer"
        severity = "high"
        category = "cryptominer"
    strings:
        // Algorithmes de minage
        $a1 = "sha256" nocase
        $a2 = "scrypt" nocase
        $a3 = "ethash" nocase
        $a4 = "cryptonight" nocase
        $a5 = "equihash" nocase
        // Pools de minage
        $b1 = "stratum" nocase
        $b2 = "mining pool" nocase
        $b3 = "worker" nocase
        $b4 = "hashrate" nocase
        $b5 = "difficulty" nocase
        // Ressources système
        $c1 = "cpu usage" nocase
        $c2 = "gpu usage" nocase
        $c3 = "memory usage" nocase
        $c4 = "temperature" nocase
        $c5 = "fan speed" nocase
    condition:
        (2 of ($a*)) or (2 of ($b*)) or (2 of ($c*))
}

// Règles pour les wipers
rule Wiper_Behavior {
    meta:
        description = "Détection de comportements de wiper"
        severity = "critical"
        category = "wiper"
    strings:
        // Opérations de destruction
        $a1 = "format" nocase
        $a2 = "delete" nocase
        $a3 = "wipe" nocase
        $a4 = "overwrite" nocase
        $a5 = "zero" nocase
        // Fichiers système
        $b1 = "boot" nocase
        $b2 = "system" nocase
        $b3 = "windows" nocase
        $b4 = "linux" nocase
        $b5 = "kernel" nocase
        // Commandes destructives
        $c1 = "rm -rf" nocase
        $c2 = "del /f /s /q" nocase
        $c3 = "format c:" nocase
        $c4 = "dd if=/dev/zero" nocase
        $c5 = "shred" nocase
    condition:
        (2 of ($a*)) or (2 of ($b*)) or (2 of ($c*))
}

// Règles pour les loaders
rule Loader_Behavior {
    meta:
        description = "Détection de comportements de loader"
        severity = "high"
        category = "loader"
    strings:
        // Chargement de DLL
        $a1 = "LoadLibrary" nocase
        $a2 = "GetProcAddress" nocase
        $a3 = "VirtualAlloc" nocase
        $a4 = "WriteProcessMemory" nocase
        $a5 = "CreateRemoteThread" nocase
        // Injection
        $b1 = "SetWindowsHookEx" nocase
        $b2 = "QueueUserAPC" nocase
        $b3 = "NtMapViewOfSection" nocase
        $b4 = "RtlCreateUserThread" nocase
        $b5 = "ZwCreateThreadEx" nocase
        // Persistance
        $c1 = "RunOnce" nocase
        $c2 = "Startup" nocase
        $c3 = "Services" nocase
        $c4 = "Scheduled Tasks" nocase
        $c5 = "Registry" nocase
    condition:
        (2 of ($a*)) or (2 of ($b*)) or (2 of ($c*))
}

// Règles pour les packers
rule Packer_Behavior {
    meta:
        description = "Détection de comportements de packer"
        severity = "medium"
        category = "packer"
    strings:
        // Techniques de packing
        $a1 = "upx" nocase
        $a2 = "aspack" nocase
        $a3 = "fsg" nocase
        $a4 = "petite" nocase
        $a5 = "winupack" nocase
        // Décompression
        $b1 = "inflate" nocase
        $b2 = "decompress" nocase
        $b3 = "unpack" nocase
        $b4 = "decode" nocase
        $b5 = "decrypt" nocase
        // Sections suspectes
        $c1 = ".upx" nocase
        $c2 = ".packed" nocase
        $c3 = ".encrypted" nocase
        $c4 = ".compressed" nocase
        $c5 = ".protected" nocase
    condition:
        (2 of ($a*)) or (2 of ($b*)) or (2 of ($c*))
}

// Règles pour les obfuscateurs
rule Obfuscator_Behavior {
    meta:
        description = "Détection de comportements d'obfuscateur"
        severity = "medium"
        category = "obfuscator"
    strings:
        // Techniques d'obfuscation
        $a1 = "xor" nocase
        $a2 = "rol" nocase
        $a3 = "ror" nocase
        $a4 = "shl" nocase
        $a5 = "shr" nocase
        // Chaînes obfusquées
        $b1 = "base64" nocase
        $b2 = "hex" nocase
        $b3 = "unicode" nocase
        $b4 = "utf-8" nocase
        $b5 = "ascii" nocase
        // Fonctions de décodage
        $c1 = "decode" nocase
        $c2 = "decrypt" nocase
        $c3 = "deobfuscate" nocase
        $c4 = "unpack" nocase
        $c5 = "extract" nocase
    condition:
        (2 of ($a*)) or (2 of ($b*)) or (2 of ($c*))
} 